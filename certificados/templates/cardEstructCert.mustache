<div class="card rounded-0" id="cardDatosCertificado">
    <div class="card-header">
        Correspondencia con el Catálogo Modular de Formación Profesional
        <span class="right">
            <button id="buttonModalAddMF" type="button" class="btn btn-oficial" data-toggle="modal" data-target="#modalAddMF">
              <i class="fas fa-plus"></i>
            </button>
        </span>
    </div>
    <div class="card-body p-0" id="cardMFsUFs">
        <table class="table table-hover table-striped table-bordered text-oficial mb-0" id="tableMFsUFs">
            <thead class="text-center">
            <tr class="text-center">
                <th class="align-middle">Nivel</th>
                <th class="align-middle">Módulo Formativo</th>
                <th class="align-middle">UC</th>
                <th class="align-middle">Horas</th>
                <th class="align-middle">Examen</th>
                <th class="align-middle">Unidades Formativas</th>
                <th class="align-middle">Formación</th>
                <th class="align-middle">Tutorías</th>
                <th class="align-middle">Total</th>
            </tr>
            </thead>
            <tbody id="tableBodyMFsUFs">
            {{#listMFsUFs}}
                <tr>
                {{#datosMFs}}
                        <td class="text-center align-middle {{ClassTransversal}}" rowspan="{{numUFs}}">{{Nivel}}</td>
                        <td class="align-middle {{ClassTransversal}}" rowspan="{{numUFs}}">
                            {{#MP}}
                                <a tabindex="0" data-html="true" role="button" data-toggle="popover" class="textPopover" data-trigger="focus" title="<span class='titlePopover' style='font-size:1rem'>{{TextoModulo}}</span>" data-content="<div class='d-flex justify-content-around'><a href='#' class='editMFModal' title='Editar Módulo Formativo' aria-IdModulo='{{IdModulo}}' aria-IdCertificado='{{IdCertificado}}'><i class='fas fa-pencil-alt fa-lg text-warning'></i></a> <a href='#' aria-IdModulo='{{IdModulo}}'  aria-IdCertificado='{{IdCertificado}}' class='delMFCert' title='Quitar Módulo del Certificado de Profesionalidad'><i class='far fa-trash-alt fa-lg text-danger'></i></a></div>">
                                    {{TextoModulo}}
                                </a>
                            {{/MP}}
                            {{^MP}}
                                <a tabindex="0" data-html="true" role="button" data-toggle="popover" class="textPopover {{IdMoodleClass}}" data-trigger="focus" title="<span class='titlePopover' style='font-size:1rem'>{{TextoModulo}}</span>" data-content="<div class='d-flex justify-content-around'><a href='#' class='addUFMF' aria-IdModulo='{{IdModulo}}' aria-IdCertificado='{{IdCertificado}}' title='Añadir Unidad Formativa'><i class='fas fa-plus fa-lg'></i></a> <a href='#' class='sincroUFMF' aria-IdModulo='{{IdModulo}}' aria-IdEntidad='{{IdModulo}}' aria-CodMoodle='{{IdCertificado}}/{{IdModulo}}/1C' aria-IdCertificado='{{IdCertificado}}' aria-TipoEntidad='Modulo'  aria-IdMoodleCurso='{{IdMoodleCurso}}' title='Sincronizar con Moodle'><i class='fas fa-spinner fa-lg text-oficial'></i></a> <a href='#' class='editMFModal' title='Editar Módulo Formativo' aria-IdModulo='{{IdModulo}}' aria-IdCertificado='{{IdCertificado}}'><i class='fas fa-pencil-alt fa-lg text-warning'></i></a> <a href='#' aria-IdModulo='{{IdModulo}}'  aria-IdCertificado='{{IdCertificado}}' class='delMFCert' title='Quitar Módulo del Certificado de Profesionalidad'><i class='far fa-trash-alt fa-lg text-danger'></i></a></div>">
                                    {{TextoModulo}}
                                </a>
                            {{/MP}}
                        </td>
                        <td class="text-center align-middle {{ClassTransversal}}" rowspan="{{numUFs}}">
                            {{#UC}}
                                {{IdUC}}
                            {{/UC}}
                        </td>
                        <td class="text-center align-middle {{ClassTransversal}}" rowspan="{{numUFs}}">{{HorasModTotales}}</td>
                        <td class="text-center align-middle {{ClassTransversal}}" rowspan="{{numUFs}}">{{HorasModExamen}}</td>
                {{/datosMFs}}
                {{#listUFs}}
                        <td class=" {{ClassTransversal}}">
                            <a tabindex="0" data-html="true" role="button" data-toggle="popover" class="textPopover" data-trigger="focus" title="<span class='titlePopover' style='font-size:1rem'>{{TextoUnidad}}</span>" data-content="<div class='d-flex justify-content-around'><a href='#' class='editUFModal' title='Editar Unidad Formativa' aria-IdUnidad='{{IdUnidad}}' aria-IdModulo='{{IdModulo}}' aria-IdCertificado='{{IdCertificado}}'><i class='fas fa-pencil-alt fa-lg text-warning'></i></a> <a href='#' aria-IdUnidad='{{IdUnidad}}' aria-NodoFormacion='{{IdModulo}}' aria-IdEntidad='{{IdUnidad}}' aria-CodMoodle='{{IdCertificado}}/{{IdModulo}}/{{IdUnidad}}/1C' aria-IdCertificado='{{IdCertificado}}' aria-TipoEntidad='Unidad'  aria-IdMoodleCurso='{{IdMoodleCurso}}' class='sincroUFMF' title='Sincronizar con Moodle'><i class='fas fa-spinner fa-lg text-oficial'></i></a> <a href='#' aria-IdUnidad='{{IdUnidad}}' aria-IdModulo='{{IdModulo}}' aria-IdCertificado='{{IdCertificado}}' class='delUFMF' title='Quitar Unidad Formativa del Módulo Formativo'><i class='far fa-trash-alt fa-lg text-danger'></i></a></div>">{{TextoUnidad}}</a>
                        </td>
                        <td class="text-center align-middle {{ClassTransversal}}">{{HorasUniFormacion}}</td>
                        <td class="text-center align-middle {{ClassTransversal}}">{{HorasUniTutoria}}</td>
                        <td class="text-center align-middle {{ClassTransversal}}">{{HorasUniTotales}}</td>
                    </tr>
                {{/listUFs}}
                {{^listUFs}}
                    {{#datosMFs}}
                        <td class="text-center {{ClassTransversal}}"></td>
                        <td class="text-center align-middle {{ClassTransversal}}">{{HorasModFormacion}}</td>
                        <td class="text-center align-middle {{ClassTransversal}}">{{HorasModTutoria}}</td>
                        <td class="text-center align-middle {{ClassTransversal}}">{{HorasModTotales}}</td>
                        </tr>
                    {{/datosMFs}}
                {{/listUFs}}
            {{/listMFsUFs}}
            {{^listMFsUFs}}
                <tr>
                    <td colspan="9" class="text-center">No se ha podido cargar los datos de los Módulos Formativos.</td>
                </tr>
            {{/listMFsUFs}}
            </tbody>
        </table>
    </div>
</div>
<div class="modal fade" id="modalEditMF" tabindex="-1" aria-labelledby="modalEditMF" aria-hidden="true">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="modalEditMFTitle">Editar Módulo Formativo</h5>
            </div>
            <div class="modal-body" id="modalBodyEditMF">

            </div>
        </div>
    </div>
</div>
<div class="modal fade" id="editUFModal" tabindex="-1" aria-labelledby="editUFModal" aria-hidden="true">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="editUFModalTitle">Editar Unidad Formativa</h5>
            </div>
            <div class="modal-body" id="modalBodyEditUF">

            </div>
        </div>
    </div>
</div>
<script>
    $(function () {
        inicializarPopOver();
    });

    $('body').on( 'click', '.addUFMF', function (e) {
        e.preventDefault();
        $('#idMFnewUF').val($(this).attr('aria-IdModulo'));
        $('#idMFAddUF').val($(this).attr('aria-IdModulo'));
        $('#sendFormModalAddMF').html('<i class="fas fa-plus"></i>');
        $('#sendFormModalSaveMF').html('<i class="far fa-save fa-lg"></i>');
        $('#sendformModalSaveUF').html('<i class="far fa-save fa-lg"></i>');
        $('#sendFormModalAddUF').html('<i class="fas fa-plus"></i>');
        $('#modalAddUF').modal('show');
    });
    $('body').on( 'click', '.editMFModal', function (e) {
        $.ajax({
            url: "ajax/obterMF.php",
            data: {IdCertificado:$(this).attr('aria-IdCertificado'),IdModulo:$(this).attr('aria-IdModulo')},
            type: "POST",
            dataType: "json",
            success: function (data) {
                if(data.resultado){
                    alert("Se ha producido un error al obtener la información del Módulo Formativo. Contacte con el CAU.");
                }else{
                    var template=$('#editModalMFTem').html();
                    var renderedTemplate = Mustache.render(template,data);
                    $('#modalBodyEditMF').html(renderedTemplate);
                    inicializarEditModalMF();
                    $('#editModalMFTemIdCert').val($('#CodigoCertV').val());
                }
            }
        }).fail(function () {
            alert("Se ha producido un error al obtener los datos de la Unidad Formativa. Código 5.");
        });
        $('#modalEditMF').modal('show');
    });
    $('body').on( 'click', '.editUFModal', function (e) {
        $.ajax({
            url: "ajax/obterUF.php",
            data: {IdUnidad:$(this).attr('aria-IdUnidad'),IdModulo:$(this).attr('aria-IdModulo')},
            type: "POST",
            dataType: "json",
            success: function (data) {
                if(data.resultado){
                    alert("Se ha producido un error al obtener la información de la Unidad Formativa. Contacte con el CAU.");
                }else{
                    var template=$('#editModalUFTem').html();
                    var renderedTemplate = Mustache.render(template,data);
                    $('#modalBodyEditUF').html(renderedTemplate);
                    inicializarEditModalUF();
                    $('#formEditModalUFIdCert').val($('#CodigoCertV').val());
                }
            }
        }).fail(function () {
            alert("Se ha producido un error al obtener los datos de la Unidad Formativa. Código 5.");
        });
        $('#editUFModal').modal('show');
    });
    $('body').on( 'click', '.delMFCert', function (e) {
        e.preventDefault();
        $.ajax({
            url: "ajax/delMFCert.php",
            data: {IdModulo:$(this).attr('aria-IdModulo'),IdCertificado:$(this).attr('aria-IdCertificado')},
            type: "POST",
            dataType: "json",
            success: function (data) {
                if(data.resultado){
                    alert("Se ha producido un error al desasignar el Módulo Formativo del Certificado de Profesionalidad. Contacte con el CAU.");
                }else{
                    var template=$('#estrCertTem').html();
                    var renderedTemplate = Mustache.render(template,data);
                    $('#tableBodyMFsUFs').html(renderedTemplate);
                    inicializarPopOver();
                }
            }
        }).fail(function () {
            alert("Se ha producido un error al desasignar la Unidad Formativa. Código 5.");
        });
    });
    $('body').on( 'click', '.delUFMF', function (e) {
        e.preventDefault();
        $.ajax({
            url: "ajax/delUFMF.php",
            data: {IdModulo:$(this).attr('aria-IdModulo'),IdCertificado:$(this).attr('aria-IdCertificado'),IdUnidad:$(this).attr('aria-IdUnidad')},
            type: "POST",
            dataType: "json",
            success: function (data) {
                if(data.resultado){
                    alert("Se ha producido un error al desasignar la Unidad Formativa del Módulo Formativo. Contacte con el CAU.");
                }else{
                    var template=$('#estrCertTem').html();
                    var renderedTemplate = Mustache.render(template,data);
                    $('#tableBodyMFsUFs').html(renderedTemplate);
                    inicializarPopOver();
                }
            }
        }).fail(function () {
            alert("Se ha producido un error al desasignar la Unidad Formativa. Código 5.");
        });
    });
    function inicializarEditModalMF(){
        $('#formEditModalMFTem').ajaxForm({
            beforeSubmit : function(formData, $form, options) {
                var f=$form[0];
                if (!f.IdCertificado.value) {
                    alert('Error en el identificador del Certificado.Contacta con el CAU.');
                    return false;
                }
                if (!f.IdModuloOrig.value) {
                    alert('Error en el identificador del Módulo.Contacta con el CAU.');
                    return false;
                }
                if (!f.Modo.value) {
                    alert('Error en el Modo del formulario. Contacta con el CAU.');
                    return false;
                }
                if (!f.Codigo.value) {
                    alert('Debes insertar el código válido de la Unidad Formativa');
                    return false;
                }else{
                    if(!f.Codigo.value){
                        alert('Debes insertar un Código válido.');
                        return false;
                    }
                }
                if ((f.HorasFormacion.value)&&(f.HorasExamen.value)&&(f.HorasTotales.value)) {
                    if((parseInt(f.HorasFormacion.value)+parseInt(f.HorasTutoria.value)+parseInt(f.HorasExamen.value))==(parseInt(f.HorasTotales.value))){
                        return true;
                    }else{
                        alert('La suma de las horas no coincide. REVISALAS.');
                        return false;
                    }
                }else{
                    alert('Debes especificar las horas de la Unidad Formativa.');
                    return false;
                }
            },
            success: function(data) {
                if(data.resultado){
                    alert("Se ha producido un error al guardar la Unidad Formativa. Contacte con el CAU.");
                }else{
                    var template=$('#estrCertTem').html();
                    var renderedTemplate = Mustache.render(template,data);
                    $('#tableBodyMFsUFs').html(renderedTemplate);
                    $('#formEditModalMFTem').clearForm();
                    $('#modalEditMF').modal('hide');
                    inicializarPopOver();
                }
            }
        });
    }
    function inicializarEditModalUF(){
        $('#formEditModalUF').ajaxForm({
            beforeSubmit : function(formData, $form, options) {
                var f=$form[0];
                if (!f.IdCertificado.value) {
                    alert('Error en el identificador del Certificado de Profesionalidad. Contacta con el CAU.');
                    return false;
                }
                if (!f.IdModulo.value) {
                    alert('Error en el identificador del Módulo Formativo. Contacta con el CAU.');
                    return false;
                }
                if (!f.IdUnidadOrig.value) {
                    alert('Error en el identificador de la Unidad Formativa. Contacta con el CAU.');
                    return false;
                }
                if (!f.Modo.value) {
                    alert('Error en el Modo del formulario. Contacta con el CAU.');
                    return false;
                }
                if (!f.Codigo.value) {
                    alert('Debes insertar el código válido de la Unidad Formativa');
                    return false;
                }else{
                    if(!validarUF(f.Codigo.value)){
                        alert('Debes insertar un Código válido.');
                        return false;
                    }
                }
                if ((f.HorasFormacion.value)&&(f.HorasExamen.value)&&(f.HorasTotales.value)) {
                    if((parseInt(f.HorasFormacion.value)+parseInt(f.HorasTutoria.value)+parseInt(f.HorasExamen.value))==(parseInt(f.HorasTotales.value))){
                        return true;
                    }else{
                        alert('La suma de las horas no coincide. REVISALAS.');
                        return false;
                    }
                }else{
                    alert('Debes especificar las horas de la Unidad Formativa.');
                    return false;
                }
            },
            success: function(data) {
                if(data.resultado){
                    alert("Se ha producido un error al guardar la Unidad Formativa. Contacte con el CAU.");
                }else{
                    var template=$('#estrCertTem').html();
                    var renderedTemplate = Mustache.render(template,data);
                    $('#tableBodyMFsUFs').html(renderedTemplate);
                    $('#formEditModalMFTem').clearForm();
                    $('#editUFModal').modal('hide');
                    inicializarPopOver();
                }
            }
        });
    }
    function inicializarPopOver() {
        $('[data-toggle="popover"]').popover();
    }
</script>
